// This file is part of Christmas Event 
// author: Jenalya, Chayenne, cinderweb, wushin
// please see #XmasConfig

function|script|XmasNaughty|,
{
    set @xmas_karma, ((XMASTIME & NIBBLE_1_MASK) >> NIBBLE_1_SHIFT);
    if((@xmas_karma - @karma_bonus) > 0)
        set @xmas_karma, (@xmas_karma - @karma_bonus);
    set XMASTIME, (XMASTIME & ~(NIBBLE_1_MASK) | (@xmas_karma << NIBBLE_1_SHIFT));
    set @karma_bonus, 0;
    return;
}

function|script|XmasNice|,
{
    set @xmas_karma, ((XMASTIME & NIBBLE_1_MASK) >> NIBBLE_1_SHIFT);
    if((@xmas_karma + @karma_bonus) < 16)
        set @xmas_karma, (@karma_bonus + @xmas_karma);
    set XMASTIME, (XMASTIME & ~(NIBBLE_1_MASK) | (@xmas_karma << NIBBLE_1_SHIFT));
    set @karma_bonus, 0;
    return;
}

function|script|XmasSetState|,
{
    set XMASTIME, (XMASTIME & ~(NIBBLE_0_MASK) | (@xmas_state << NIBBLE_0_SHIFT));
    return;
}

function|script|XmasSetSide|,
{
    set XMASTIME, XMASTIME | $@xmas_side_bit;
    return;
}

function|script|ThrowOutTheBum|,
{
    callfunc "XmasStates";

    if(@xmas_side)
        goto L_NaughtyStatus;
    goto L_Return;

L_NaughtyStatus:
    if(@xmas_thrown_out)
        goto L_Warp;
    goto L_Hint;

L_Hint:
    // callfunct "ThrownOutHint";
    message strcharinfo(0), "I said get out, We've no time for your kind here.";
    mes "[Orum's Homunculus]";
    mes "\"What are you doing? Come See me in the Caves Below.\"";
    mes "\"I said go north till you reach the snoman. Then head into the cave to the east.\"";
    warp "030-1",99,55;
    close;

L_Warp:
    message strcharinfo(0), "I said get out, We've no time for your kind here.";
    warp "030-1",99,55;
    end;

L_Return:
    return;
}

function|script|XmasCheckList|,
{
    set @xmas_list_count, 0;
    set @xmas_list_loop, 0;

L_Loop:
    if(XMASTIME & $@child_list[@xmas_list_loop])
        goto L_AddOne;
    goto L_LoopAgain;

L_AddOne:
    set @xmas_list_count, (@xmas_list_count + 1);
    if(@xmas_list_loop == getarraysize($@child_list))
        goto L_ListTally;
    goto L_LoopAgain;

L_LoopAgain:
    set @xmas_list_loop, @xmas_list_loop + 1;
    goto L_Loop;

L_ListTally:
    if(@xmas_list_count == $@perfect_list_count)
        goto L_PerfectList;
    if(@xmas_list_count > $@required_list_count)
        goto L_LooksGood;
    goto L_Return;

L_PerfectList:
    set XMASTIME, XMASTIME | $@all_lists_bit;
    goto L_LooksGood;

L_SetListState:
    set @xmas_state, $@xmas_list_complete_state;
    callfunc "XmasSetState";
    goto L_Return;

L_Return:
    set @xmas_list_count, 0;
    set @xmas_list_loop, 0;
    return;
}

function|script|XmasList|,
{
    callfunc "XmasStates";

    if(@xmas_gather_list)
        goto L_QuestTime;
    goto L_Return;

L_QuestTime:
    if(XMASTIME & $@child_list[$@child_number])
        goto L_Return;
    goto L_GetList;

L_GetList:
    // Change to Menu, with options
    menu
        "I have come for your list", L_List,
        "Actaully, what have you got to say.", L_Return;

L_List:
    mes $@child_list_name$[$@child_number];
    mes "Here is my list. Make sure it gets delivered please!";
    set XMASTIME, XMASTIME | $@child_list[$@child_number];
    set @karma_bonus, $@default_karma_bonus;
    callfunc "XmasNice";
    menu
        "Thank you I have to be going.", L_Close,
        "Actually could I ask you something else.", L_Return;

L_Close:
    close;

L_Return:
    set @karma_bonus, 0;
    return;
}

function|script|XmasHelperPoints|,
{
    callfunc "XmasStates";
    set @xmas_helper_count, 0;
    set @xmas_helper_loop, 0;

L_Loop:
    if(XMASTIME & $@helper_list[@xmas_helper_loop])
        goto L_AddOne;
    goto L_LoopAgain;

L_AddOne:
    set @xmas_helper_count, (@xmas_helper_count + 1);
    if(@xmas_helper_loop == getarraysize($@helper_list))
        goto L_HelperTally;
    goto L_LoopAgain;

L_LoopAgain:
    set @xmas_helper_loop, @xmas_helper_loop + 1;
    goto L_Loop;

L_HelperTally:
    if(@xmas_helper_count == $@perfect_helpers_count)
        goto L_PerfectHelpers;
    if(@xmas_helper_count > $@required_helpers_count)
        goto L_HelperDone;
    goto L_Return;

L_PerfectHelpers:
    set XMASTIME, XMASTIME | $@all_helpers_bit;
    goto L_Return;

L_SetHelperState:
    set @xmas_state, $@xmas_helper_done_state;
    callfunc "XmasSetState";
    goto L_Return;

L_Return:
    set @xmas_helper_count, 0;
    set @xmas_helper_loop, 0;
    return;
}

function|script|CheckReagents|,
{
    set @xmas_reagent_loop, 0;

    if(@xmas_side)
        goto L_OneLoop;
    goto L_ZeroLoop;

L_ZeroLoop:
    if(countitem($@quest_side_zero_reagents$[@xmas_reagent_loop]) == @quest_side_zero_reagents_amounts[@xmas_reagent_loop])
        goto L_ZeroAddOne;
    goto L_NotEnough;

L_ZeroAddOne:
    if(@xmas_reagent_loop == getarraysize($@quest_side_zero_reagents$))
        goto L_AllReagents;
    goto L_ZeroLoopAgain;

L_ZeroLoopAgain:
    set @xmas_reagent_loop, @xmas_reagent_loop + 1;
    goto L_ZeroLoop;

L_OneLoop:
    if(countitem($@quest_side_one_reagents$[@xmas_reagent_loop]) == @quest_side_one_reagents_amounts[@xmas_reagent_loop])
        goto L_OneAddOne;
    goto L_NotEnough;

L_OneAddOne:
    if(@xmas_reagent_loop == getarraysize($@quest_side_one_reagents$))
        goto L_AllReagents;
    goto L_OneLoopAgain;

L_OneLoopAgain:
    set @xmas_reagent_loop, @xmas_reagent_loop + 1;
    goto L_OneLoop;

L_NotEnough:
    mes "\" I'm sorry but could you come back when you have the components?\"";
    close;
    end;

L_AllReagents:
    set @xmas_state, $@xmas_reagents_gathered;
    callfunc "XmasSetState";
    close;
    end;
}

function|script|XmasReward|,
{
    if($@xmas_time == $@xmas_reward_time)
        goto L_FinalGift;
    goto L_NotTime;

L_FinalGift:
    // Random Reward Generator Based off 2 arrays Naughty and Nice;
    // Check side
    // get karma
    // 50 +/- karma depending on side
    // Plus Perfects/Hard mode
    // Give X presents by trees.
    // Remember to clear that shit for next year.
    end;

L_NotTime:
    end;
}

function|script|XmasCheckOld|,
{
    set @xmas_key_loop, 0;

L_Loop:
    if($@xmas_time_key_old[@xmas_key_loop] == XMASYEAR)
        goto L_OldMatch;
    goto L_KeyLoopAgain;

L_OldMatch:
    set XMASTIME, 0;
    set XMASYEAR, $@xmas_time_key;
    return;

L_LoopAgain:
    set @xmas_helper_loop, @xmas_helper_loop + 1;
    goto L_Loop;
}
