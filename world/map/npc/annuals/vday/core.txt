// This file is part of Christmas Event
// author: Jenalya, Chayenne, cinderweb, wushin
// please see #VdayConfig

function|script|VdayNaughty|,
{
    set @vday_karma, ((VDAYTIME & NIBBLE_1_MASK) >> NIBBLE_1_SHIFT);
    if((@vday_karma - @karma_bonus) >= 0)
        goto L_SetNaughty;
    goto L_ResetNaughty;

L_SetNaughty:
    set @vday_karma, (@vday_karma - @karma_bonus);
    goto L_Return;

L_ResetNaughty:
    set @vday_karma, 0;
    goto L_Return;

L_Return:
    set VDAYTIME, (VDAYTIME & ~(NIBBLE_1_MASK) | (@vday_karma << NIBBLE_1_SHIFT));
    set @karma_bonus, 0;
    return;
}

function|script|VdayNice|,
{
    set @vday_karma, ((VDAYTIME & NIBBLE_1_MASK) >> NIBBLE_1_SHIFT);
    if((@vday_karma + @karma_bonus) < 16)
        goto L_SetNice;
    goto L_ResetNice;

L_SetNice:
    set @vday_karma, (@karma_bonus + @vday_karma);
    goto L_Return;

L_ResetNice:
    set @vday_karma, 15;
    goto L_Return;

L_Return:
    set VDAYTIME, (VDAYTIME & ~(NIBBLE_1_MASK) | (@vday_karma << NIBBLE_1_SHIFT));
    set @karma_bonus, 0;
    return;
}

// Called for a basic reward for quests state completion
function|script|VdayXpReward|,
{
    if (BaseLevel >= 10)
        goto L_HigherLevel;
    goto L_LowLevel;

L_HigherLevel:
    getexp ((BaseLevel / 10) * ($@VDAY_BASE_BONUS_XP * BaseLevel)), 0;
    goto L_Return;

L_LowLevel:
    getexp ($@VDAY_BASE_BONUS_XP * BaseLevel), 0;
    goto L_Return;

L_Return:
    return;
}

function|script|VdaySetState|,
{
    set VDAYTIME, (VDAYTIME & ~($@VDAY_STATE_MASK) | (@vday_state << $@VDAY_STATE_SHIFT));
    return;
}

function|script|VdaySetCouple1|,
{
    set VDAYTIME, (VDAYTIME & ~($@VDAY_SUBSTATE1_MASK) | (@vday_couple1_state << $@VDAY_SUBSTATE1_SHIFT));
    return;
}

function|script|VdaySetCouple2|,
{
    set VDAYTIME, (VDAYTIME & ~($@VDAY_SUBSTATE2_MASK) | (@vday_couple2_state << $@VDAY_SUBSTATE2_SHIFT));
    return;
}

function|script|VdaySetCouple3|,
{
    set VDAYTIME, (VDAYTIME & ~($@VDAY_SUBSTATE3_MASK) | (@vday_couple3_state << $@VDAY_SUBSTATE3_SHIFT));
    return;
}

function|script|VdaySetPot1|,
{
    set VDAYTIME, (VDAYTIME | $@VDAY_POT1_BIT);
    return;
}

function|script|VdaySetPot2|,
{
    set VDAYTIME, (VDAYTIME | $@VDAY_POT2_BIT);
    return;
}

// Main quest completion reward
function|script|VdayMainXpBpReward|,
{
    callfunc "VdaySetReward";

    if(BaseLevel >= 70)
        goto L_EndGameReward;
    goto L_LevelingReward;

L_EndGameReward:
    set @vday_bp_reward, 100 + rand(@vday_reward, 2 * @vday_reward);
    set BOSS_POINTS, BOSS_POINTS + @vday_bp_reward;
    message strcharinfo(0), "You gain " + @vday_bp_reward + " Bosspoints, giving you a total of " + BOSS_POINTS + ".";
    set @vday_bp_reward, 0;
    return;

L_LevelingReward:
    if(@vday_reward >= $@vday_reward_tally_rare)
        goto L_VdayLevel;
    goto L_VdayExp;

L_VdayLevel:
    gmcommand "@blvl 1";
    gmcommand "@l I was a good kid this year.";
    return;

L_VdayExp:
    getexp ((@vday_reward * BaseLevel * (BaseLevel + 10)) / 10), 0;
    return;
}

// Final Item reward
function|script|VdayMainReward|,
{
    mes "[[thank you, i planned to give you a reward,]]";
    getinventorylist;
    if (@inventorylist_count > 99)
        goto L_FullInv;
    if (countitem($@VDAY_REWARD_COUPLE$[1]) == 0 ||
        countitem($@VDAY_REWARD_COUPLE$[2]) == 0 ||
        countitem($@VDAY_REWARD_COUPLE$[3]) == 0)
        goto L_NoItems;
    if(checkweight($@VDAY_REWARD_RARE$, 1) == 0)
        goto L_FullInv;
    delitem $@VDAY_REWARD_COUPLE$[1], 1;
    delitem $@VDAY_REWARD_COUPLE$[2], 1;
    delitem $@VDAY_REWARD_COUPLE$[3], 1;

    getitem $@VDAY_REWARD_RARE$, 1;
    set @vday_state, $@VDAY_RECEIVED_STATE;
    callfunc "VdaySetState";
    goto L_Return;

L_FullInv:
    mes "[[Too much stuff]]";
    goto L_Return;

L_NoItems:
    mes "[[But you don't have what's needed]]";
    goto L_Return;

L_Return:
    return;
}

// Checks for an expired event key
// Each new annual event needs a new key
// or it will allow completion from last year
function|script|VdayCheckOld|,
{
    if(VDAYYEAR == $VDAY_TIME_KEY[4])
        goto L_Return;

L_OldMatch:
    set VDAYTIME, 0;
    set VDAYYEAR, $VDAY_TIME_KEY[4];
    goto L_Return;

L_Return:
    return;
}
